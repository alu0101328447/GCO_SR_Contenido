<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesar Archivo</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>

<body>

    <div class="container mt-5">
        <h1 class="mb-4">Procesar Archivo</h1>

        <div class="form-group col-md-6">
            <label for="fileInput">Selecciona los archivos a procesar:</label>
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="fileInput" accept=".txt" multiple />
                <label class="custom-file-label" for="fileInput">Elige los archivos...</label>
            </div>
        </div>

        <div class="form-group col-md-6">
            <label for="stopWordsInput">Selecciona el archivo de palabras de parada:</label>
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="stopWordsInput" accept=".txt" />
                <label class="custom-file-label" for="stopWordsInput">Elige un archivo...</label>
            </div>
        </div>

        <div class="form-group col-md-6">
            <label for="lemmatizationInput">Selecciona el archivo de lematización:</label>
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="lemmatizationInput" accept=".txt" />
                <label class="custom-file-label" for="lemmatizationInput">Elige un archivo...</label>
            </div>
        </div>

        <div class="form-group col-md-6">
            <button id="processButton" class="btn btn-primary">Procesar</button>
        </div>
    </div>

    <script>
        document.getElementById("fileInput").addEventListener("change", function () {
            const label = this.nextElementSibling;
            label.innerText = this.files.length ? `${this.files.length} archivos seleccionados` : "Elige un archivo...";
        });

        document.getElementById("stopWordsInput").addEventListener("change", function () {
            const fileName = this.files[0] ? this.files[0].name : "Elige un archivo...";
            this.nextElementSibling.innerText = fileName;
        });

        document.getElementById("lemmatizationInput").addEventListener("change", function () {
            const fileName = this.files[0] ? this.files[0].name : "Elige un archivo...";
            this.nextElementSibling.innerText = fileName;
        });

        class PalabrasManager {
            constructor() {
                this.stopWords = [];
                this.lemmatizationDict = {};
                this.resultados = {};
                this.total = 0;
                this.idf = {};
            }

            cargarStopWords(content) {
                this.stopWords = content.split('\n').map(word => word.trim().toLowerCase()).filter(Boolean);
            }

            cargarLematizacion(content) {
                this.lemmatizationDict = JSON.parse(content);
            }

            esStopWord(palabra) {
                return this.stopWords.includes(palabra);
            }

            lematizar(palabra) {
                return this.lemmatizationDict[palabra] || palabra;
            }

            procesarArchivo(content) {
                const palabras = content.replace(/[.,;!?()""]/g, '').split(/\s+/).filter(Boolean);
                this.total = 0;

                palabras.forEach((palabra, indice) => {
                    const palabraLower = palabra.toLowerCase();

                    if (!this.esStopWord(palabraLower)) {
                        const lematizada = this.lematizar(palabraLower);

                        if (!this.resultados[lematizada]) {
                            this.resultados[lematizada] = { count: 0, index: indice };
                        }
                        this.resultados[lematizada].count += 1;
                        this.total++;
                    }
                });
            }

            calcularIDF(documentos) {
                const N = documentos.length;
                const documentoFrecuencia = {};

                if (N === 0) {
                    console.log("No se encontraron documentos para procesar.");
                    return;
                }
                console.log(`Número total de documentos: ${N}`);

                documentos.forEach(content => {
                    const palabrasUnicas = new Set(
                        content.replace(/[.,;!?()""]/g, '').split(/\s+/).map(palabra => this.lematizar(palabra.toLowerCase())).filter(Boolean)
                    );

                    palabrasUnicas.forEach(palabra => {
                        if (!this.esStopWord(palabra)) {
                            documentoFrecuencia[palabra] = (documentoFrecuencia[palabra] || 0) + 1;
                        }
                    });
                });

                for (const [palabra, dfx] of Object.entries(documentoFrecuencia)) {
                    this.idf[palabra] = Math.log(N / dfx);
                    //console.log(`Palabra: ${palabra}, dfx: ${dfx}, IDF: ${this.idf[palabra]}`);
                }
            }

            calcularTF() {
                for (const palabra in this.resultados) {
                    const count = this.resultados[palabra].count;
                    const frecuencia = 1 + Math.log(count);
                    this.resultados[palabra].frecuencia = frecuencia;
                }
                console.log("TF Calculado para cada palabra:", this.resultados);
            }
        }

        const palabrasManager = new PalabrasManager();

        document.getElementById('processButton').addEventListener('click', function() {
            const stopWordsInput = document.getElementById('stopWordsInput');
            const lemmatizationInput = document.getElementById('lemmatizationInput');
            const fileInput = document.getElementById('fileInput');

            if (stopWordsInput.files.length === 0 || lemmatizationInput.files.length === 0 || fileInput.files.length === 0) {
                alert('Por favor, selecciona todos los archivos necesarios.');
                return;
            }

            const documentos = [];

            const stopWordsReader = new FileReader();
            stopWordsReader.onload = function(event) {
                palabrasManager.cargarStopWords(event.target.result);

                const lemmatizationReader = new FileReader();
                lemmatizationReader.onload = function(event) {
                    palabrasManager.cargarLematizacion(event.target.result);

                    Array.from(fileInput.files).forEach((file, index) => {
                        const mainFileReader = new FileReader();
                        mainFileReader.onload = function(event) {
                            const mainFileContent = event.target.result;

                            palabrasManager.procesarArchivo(mainFileContent);
                            palabrasManager.calcularTF(); // Calcular TF para cada archivo
                            documentos.push(mainFileContent);

                            if (documentos.length === fileInput.files.length) {
                                palabrasManager.calcularIDF(documentos);
                                console.log("Resultados IDF:", palabrasManager.idf);
                            }
                        };

                        mainFileReader.onerror = function(event) {
                            alert('Error al leer el archivo: ' + event.target.error.code);
                        };

                        mainFileReader.readAsText(file);
                    });
                };

                lemmatizationReader.onerror = function(event) {
                    alert('Error al leer el archivo de lematización: ' + event.target.error.code);
                };

                lemmatizationReader.readAsText(lemmatizationInput.files[0]); 
            };

            stopWordsReader.onerror = function(event) {
                alert('Error al leer el archivo de palabras de parada: ' + event.target.error.code);
            };

            stopWordsReader.readAsText(stopWordsInput.files[0]); 
        });
    </script>
</body>

</html>
